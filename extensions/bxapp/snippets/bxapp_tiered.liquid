{% assign bundle_data = product.metafields.bxgy_bundle.tiered_config.value %}

{% comment %} If no product-level config, check shop-level tiered bundles for collection/all triggers {% endcomment %}
{% if bundle_data == blank %}
  {% assign shop_tiered_bundles = shop.metafields.bxgy_bundle.tiered_bundles.value %}
  {% if shop_tiered_bundles != blank %}
    {% for sb in shop_tiered_bundles %}
      {% if sb.triggerType == "all" %}
        {% assign bundle_data = sb %}
        {% break %}
      {% elsif sb.triggerType == "collection" and sb.triggerReference != blank %}
        {% for col in product.collections %}
          {% assign col_gid = "gid://shopify/Collection/" | append: col.id %}
          {% if col_gid == sb.triggerReference %}
            {% assign bundle_data = sb %}
            {% break %}
          {% endif %}
        {% endfor %}
        {% if bundle_data != blank %}{% break %}{% endif %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endif %}

{% if bundle_data != blank %}
  {% comment %} Design from metafield with fallback {% endcomment %}
  {% assign ds_accent = bundle_data.designAccentColor | default: "#8cb600" %}
  {% assign ds_bg = bundle_data.designBackgroundColor | default: "#fafff0" %}
  {% assign ds_text = bundle_data.designTextColor | default: "#1a1a1a" %}
  {% assign ds_border_radius = bundle_data.designBorderRadius | default: 12 %}
  {% assign ds_button_color = bundle_data.designButtonColor | default: "#8cb600" %}
  {% assign ds_button_text = bundle_data.designButtonTextColor | default: "#ffffff" %}

  {% assign header_text = bundle_data.designHeaderText | default: "BUILD YOUR COMBO & SAVE" %}
  {% assign gift_text = bundle_data.designGiftText | default: "+ FREE special gift!" %}
  {% assign ds_card_layout = bundle_data.designCardLayout | default: "vertical" %}

  {% comment %} Dynamic tiers from metafield array {% endcomment %}
  {% assign tiers = bundle_data.tiers %}
  {% assign buy_price = product.price %}
  {% assign buy_title = product.title %}

<style>
  .bxgy-tiers {
    background: {{ ds_bg }};
    border-radius: {{ ds_border_radius }}px;
    padding: 20px;
    margin: 16px 0;
    font-family: inherit;
    border: 1px solid #e5e5e5;
  }
  .bxgy-tiers__header {
    border-bottom: 2px solid {{ ds_text }};
    padding-bottom: 10px;
    margin-bottom: 14px;
    text-align: center;
  }
  .bxgy-tiers__header-text {
    font-weight: 800;
    font-size: 15px;
    color: {{ ds_text }};
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .bxgy-tiers__list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 14px;
  }
  .bxgy-tiers__list--horizontal {
    flex-direction: row;
  }
  .bxgy-tiers__list--horizontal .bxgy-tiers__row {
    flex: 1;
    flex-direction: column;
    text-align: center;
    padding: 14px 10px;
    border-radius: 12px;
    min-width: 0;
  }
  .bxgy-tiers__list--horizontal .bxgy-tiers__label {
    justify-content: center;
    flex-direction: column;
    gap: 4px;
  }
  .bxgy-tiers__list--horizontal .bxgy-tiers__prices {
    text-align: center;
  }
  .bxgy-tiers__list--horizontal .bxgy-tiers__radio {
    order: 10;
    width: 18px;
    height: 18px;
  }
  .bxgy-tiers__list--horizontal .bxgy-tiers__radio-dot {
    width: 10px;
    height: 10px;
  }
  @media (max-width: 749px) {
    .bxgy-tiers__list--horizontal {
      flex-direction: column;
    }
    .bxgy-tiers__list--horizontal .bxgy-tiers__row {
      flex-direction: row;
      text-align: left;
      border-radius: 28px;
    }
    .bxgy-tiers__list--horizontal .bxgy-tiers__label {
      flex-direction: row;
      justify-content: flex-start;
    }
    .bxgy-tiers__list--horizontal .bxgy-tiers__prices {
      text-align: right;
    }
    .bxgy-tiers__list--horizontal .bxgy-tiers__radio {
      order: 0;
    }
  }
  .bxgy-tiers__row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    border-radius: 28px;
    border: 2px solid #e5e5e5;
    background: #fff;
    cursor: pointer;
    transition: all 0.15s ease;
    user-select: none;
  }
  .bxgy-tiers__row:hover {
    border-color: {{ ds_accent }};
  }
  .bxgy-tiers__row--selected {
    border-color: {{ ds_accent }};
    background: {{ ds_bg }};
  }
  .bxgy-tiers__radio {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: border-color 0.15s;
  }
  .bxgy-tiers__row--selected .bxgy-tiers__radio {
    border-color: {{ ds_accent }};
  }
  .bxgy-tiers__radio-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: transparent;
    transition: background 0.15s;
  }
  .bxgy-tiers__row--selected .bxgy-tiers__radio-dot {
    background: {{ ds_accent }};
  }
  .bxgy-tiers__label {
    flex: 1;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }
  .bxgy-tiers__label-text {
    font-weight: 600;
    font-size: 14px;
    color: {{ ds_text }};
  }
  .bxgy-tiers__badge {
    font-size: 11px;
    font-weight: 700;
    color: {{ ds_accent }};
    background: {{ ds_accent }}18;
    padding: 2px 10px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .bxgy-tiers__prices {
    text-align: right;
    flex-shrink: 0;
  }
  .bxgy-tiers__price-final {
    font-weight: 700;
    font-size: 16px;
    color: {{ ds_text }};
    line-height: 1.2;
  }
  .bxgy-tiers__row--selected .bxgy-tiers__price-final {
    color: {{ ds_accent }};
  }
  .bxgy-tiers__price-original {
    font-size: 12px;
    color: #999;
    text-decoration: line-through;
    line-height: 1.2;
  }
  .bxgy-tiers__gift {
    background: {{ ds_accent }}12;
    border-radius: 8px;
    padding: 12px 16px;
    text-align: center;
    margin-bottom: 14px;
  }
  .bxgy-tiers__gift-text {
    font-weight: 700;
    font-size: 14px;
    color: {{ ds_text }};
  }
  .bxgy-tiers__add-btn {
    width: 100%;
    padding: 14px 20px;
    font-size: 16px;
    font-weight: 700;
    font-family: inherit;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background: {{ ds_button_color }};
    color: {{ ds_button_text }};
    transition: opacity 0.2s;
    position: relative;
  }
  .bxgy-tiers__add-btn:hover:not(:disabled) {
    opacity: 0.9;
  }
  .bxgy-tiers__add-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .bxgy-tiers__add-btn--loading {
    color: transparent !important;
  }
  .bxgy-tiers__add-btn--loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 3px solid {{ ds_button_text }};
    border-top-color: transparent;
    border-radius: 50%;
    animation: bxgy-tiers-spin 0.7s linear infinite;
  }
  @keyframes bxgy-tiers-spin {
    to { transform: rotate(360deg); }
  }
  .bxgy-tiers__feedback {
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    padding: 8px;
    border-radius: 6px;
    margin-top: 10px;
    display: none;
  }
  .bxgy-tiers__feedback--success {
    display: block;
    color: #166534;
    background: #dcfce7;
  }
  .bxgy-tiers__feedback--error {
    display: block;
    color: #991b1b;
    background: #fee2e2;
  }
  .bxgy-tiers__footer {
    text-align: center;
    font-size: 12px;
    color: #888;
    margin-top: 10px;
  }
</style>

<div class="bxgy-tiers" id="bxgy-tiers-{{ bxapp_widget_id }}">
  {% comment %} Header {% endcomment %}
  <div class="bxgy-tiers__header">
    <span class="bxgy-tiers__header-text">{{ header_text }}</span>
  </div>

  {% comment %} Tier rows - dynamic loop {% endcomment %}
  <div class="bxgy-tiers__list bxgy-tiers__list--{{ ds_card_layout }}">
    {% for tier in tiers %}
      {% assign t_buy = tier.buyQty | default: 1 %}
      {% assign t_free = tier.freeQty | default: 1 %}
      {% assign t_disc = tier.discountPct | default: 100 %}

      {% if t_disc >= 100 %}{% assign t_deal = "free" %}{% else %}{% assign t_deal = t_disc | append: "% off" %}{% endif %}

      {% assign t_total_qty = t_buy | plus: t_free %}
      {% assign t_original = t_total_qty | times: buy_price %}
      {% assign t_free_cost = t_free | times: buy_price %}
      {% assign t_save_amount = t_free_cost | times: t_disc | divided_by: 100 %}
      {% assign t_final = t_original | minus: t_save_amount %}
      {% assign t_save_pct = t_save_amount | times: 100 | divided_by: t_original %}

      {% assign tier_index = forloop.index0 %}
      {% if forloop.index0 == 1 %}
        {% assign row_class = "bxgy-tiers__row bxgy-tiers__row--selected" %}
      {% else %}
        {% assign row_class = "bxgy-tiers__row" %}
      {% endif %}

      <div class="{{ row_class }}" data-bxgy-tier="{{ tier_index }}" data-buy-qty="{{ t_buy }}" data-free-qty="{{ t_free }}" data-disc-pct="{{ t_disc }}">
        <div class="bxgy-tiers__radio"><div class="bxgy-tiers__radio-dot"></div></div>
        <div class="bxgy-tiers__label">
          <span class="bxgy-tiers__label-text">Buy {{ t_buy }}, get {{ t_free }} {{ t_deal }}</span>
          <span class="bxgy-tiers__badge">SAVE {{ t_save_pct }}%</span>
        </div>
        <div class="bxgy-tiers__prices">
          <div class="bxgy-tiers__price-final" data-bxgy-tier-final="{{ tier_index }}">{{ t_final | money }}</div>
          <div class="bxgy-tiers__price-original" data-bxgy-tier-original="{{ tier_index }}">{{ t_original | money }}</div>
        </div>
      </div>
    {% endfor %}
  </div>

  {% comment %} Gift footer {% endcomment %}
  {% if gift_text != blank %}
    <div class="bxgy-tiers__gift">
      <span class="bxgy-tiers__gift-text">{{ gift_text }}</span>
    </div>
  {% endif %}

  {% comment %} Add to cart button {% endcomment %}
  <button
    class="bxgy-tiers__add-btn"
    data-bxgy-tiers-add-btn
    {% unless product.available %}disabled{% endunless %}
    type="button"
  >
    Add Bundle to Cart
  </button>

  {% comment %} Feedback {% endcomment %}
  <div class="bxgy-tiers__feedback" data-bxgy-tiers-feedback></div>

  {% comment %} Footer {% endcomment %}
  <div class="bxgy-tiers__footer">Discount applied automatically at checkout</div>
</div>

<script>
(function() {
  var WIDGET_ID = 'bxgy-tiers-{{ bxapp_widget_id }}';
  var widget = document.getElementById(WIDGET_ID);
  if (!widget) return;

  var shopCurrency = {{ shop.currency | json }};

  /* Product variants – keyed by numeric ID (string) */
  var buyVariants = {};
  {% for variant in product.variants %}
    buyVariants['{{ variant.id }}'] = {
      price: {{ variant.price }},
      available: {{ variant.available | json }}
    };
  {% endfor %}

  var rows = widget.querySelectorAll('[data-bxgy-tier]');
  var addBtn = widget.querySelector('[data-bxgy-tiers-add-btn]');
  var feedbackEl = widget.querySelector('[data-bxgy-tiers-feedback]');
  var selectedTier = rows.length > 1 ? 1 : 0; /* default to second tier if exists, else first */

  /* ── Helpers ── */
  function formatMoney(cents) {
    return new Intl.NumberFormat(undefined, {
      style: 'currency',
      currency: shopCurrency || 'USD'
    }).format(cents / 100);
  }

  function getSelectedVariantId() {
    /* 1. URL ?variant= param */
    var urlParams = new URLSearchParams(window.location.search);
    var v = urlParams.get('variant');
    if (v && buyVariants[v]) return v;

    /* 2. Hidden input inside product form */
    var input = document.querySelector('form[action*="/cart/add"] input[name="id"]');
    if (input && input.value && buyVariants[input.value]) return input.value;

    /* 3. Select dropdown inside product form */
    var sel = document.querySelector('form[action*="/cart/add"] select[name="id"]');
    if (sel && sel.value && buyVariants[sel.value]) return sel.value;

    /* 4. Radios (some themes) */
    var radio = document.querySelector('form[action*="/cart/add"] input[name="id"]:checked');
    if (radio && radio.value && buyVariants[radio.value]) return radio.value;

    /* 5. First available variant as fallback */
    var keys = Object.keys(buyVariants);
    for (var i = 0; i < keys.length; i++) {
      if (buyVariants[keys[i]].available) return keys[i];
    }
    return keys[0] || null;
  }

  function getVariantPrice() {
    var vid = getSelectedVariantId();
    return vid && buyVariants[vid] ? buyVariants[vid].price : 0;
  }

  /* ── Tier price update ── */
  function updateTierPrices() {
    var price = getVariantPrice();
    rows.forEach(function(row) {
      var buyQty  = parseInt(row.getAttribute('data-buy-qty'), 10);
      var freeQty = parseInt(row.getAttribute('data-free-qty'), 10);
      var discPct = parseInt(row.getAttribute('data-disc-pct'), 10) || 100;
      var totalQty = buyQty + freeQty;
      var original = totalQty * price;
      var savings  = Math.round(freeQty * price * discPct / 100);
      var finalVal = original - savings;
      var idx = row.getAttribute('data-bxgy-tier');
      var finalEl = widget.querySelector('[data-bxgy-tier-final="' + idx + '"]');
      var origEl  = widget.querySelector('[data-bxgy-tier-original="' + idx + '"]');
      if (finalEl) finalEl.textContent = formatMoney(finalVal);
      if (origEl)  origEl.textContent  = formatMoney(original);
    });
  }

  /* ── Tier selection ── */
  function selectTier(index) {
    selectedTier = index;
    rows.forEach(function(row) {
      var idx = parseInt(row.getAttribute('data-bxgy-tier'), 10);
      row.classList.toggle('bxgy-tiers__row--selected', idx === index);
    });
  }

  rows.forEach(function(row) {
    row.addEventListener('click', function() {
      selectTier(parseInt(row.getAttribute('data-bxgy-tier'), 10));
    });
  });

  /* ── Variant change listeners ── */
  var lastUrl = window.location.href;
  setInterval(function() {
    if (window.location.href !== lastUrl) {
      lastUrl = window.location.href;
      updateTierPrices();
    }
  }, 500);

  var formSelector = 'form[action*="/cart/add"]';
  var variantInput = document.querySelector(formSelector + ' input[name="id"]');
  if (variantInput) {
    new MutationObserver(function() { updateTierPrices(); })
      .observe(variantInput, { attributes: true, attributeFilter: ['value'] });
  }
  var variantSelect = document.querySelector(formSelector + ' select[name="id"]');
  if (variantSelect) {
    variantSelect.addEventListener('change', function() { updateTierPrices(); });
  }

  document.addEventListener('variant:changed', function(e) {
    if (e.detail && e.detail.variant) updateTierPrices();
  });

  /* ── Feedback ── */
  function showFeedback(type, message) {
    feedbackEl.textContent = message;
    feedbackEl.className = 'bxgy-tiers__feedback bxgy-tiers__feedback--' + type;
    if (type === 'success') {
      setTimeout(function() { feedbackEl.className = 'bxgy-tiers__feedback'; }, 4000);
    }
  }

  /* ── Refresh theme cart (drawer / header count) ── */
  function refreshCart() {
    /* Dispatch a cart update event that most themes listen for */
    document.documentElement.dispatchEvent(
      new CustomEvent('cart:refresh', { bubbles: true })
    );
    /* Also try Shopify Section Rendering API to refresh cart sections */
    fetch('/cart.js', { credentials: 'same-origin' })
      .then(function(r) { return r.json(); })
      .then(function(cart) {
        /* Update header cart count badges (common selectors) */
        var badges = document.querySelectorAll(
          '.cart-count-bubble span, .cart-count, [data-cart-count], .js-cart-count, #cart-icon-bubble span'
        );
        badges.forEach(function(el) { el.textContent = cart.item_count; });
      })
      .catch(function() { /* ignore */ });
  }

  /* ── Add to cart ── */
  addBtn.addEventListener('click', function() {
    if (addBtn.disabled) return;

    var selectedRow = widget.querySelector('[data-bxgy-tier="' + selectedTier + '"]');
    if (!selectedRow) return;

    var buyQty  = parseInt(selectedRow.getAttribute('data-buy-qty'), 10);
    var freeQty = parseInt(selectedRow.getAttribute('data-free-qty'), 10);
    var variantId = getSelectedVariantId();

    if (!variantId) {
      showFeedback('error', 'Please select a product variant.');
      return;
    }

    addBtn.disabled = true;
    addBtn.classList.add('bxgy-tiers__add-btn--loading');
    feedbackEl.className = 'bxgy-tiers__feedback';

    var totalQty = buyQty + freeQty;

    fetch('/cart/add.js', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({
        items: [{ id: parseInt(variantId, 10), quantity: totalQty }]
      })
    })
    .then(function(response) {
      if (!response.ok) {
        return response.json().then(function(data) {
          throw new Error(data.description || data.message || 'Failed to add to cart');
        });
      }
      return response.json();
    })
    .then(function() {
      addBtn.disabled = false;
      addBtn.classList.remove('bxgy-tiers__add-btn--loading');
      showFeedback('success', 'Bundle added to cart!');
      refreshCart();
    })
    .catch(function(err) {
      addBtn.disabled = false;
      addBtn.classList.remove('bxgy-tiers__add-btn--loading');
      showFeedback('error', err.message || 'Something went wrong. Please try again.');
    });
  });

  /* Init */
  updateTierPrices();
})();
</script>

{% endif %}

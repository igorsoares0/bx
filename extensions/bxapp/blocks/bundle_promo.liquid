{% assign bundle_data = product.metafields.bxgy_bundle.config.value %}

{% if bundle_data != blank %}
  {% assign discount_type = bundle_data.discountType %}
  {% assign discount_value = bundle_data.discountValue %}
  {% assign min_quantity = bundle_data.minQuantity %}
  {% assign reward_product_title = bundle_data.rewardProductTitle %}
  {% assign max_reward = bundle_data.maxReward %}
  {% assign reward_product_handle = bundle_data.rewardProductHandle %}
  {% assign reward_variant_id = bundle_data.rewardVariantId %}
  {% assign reward_product_price = bundle_data.rewardProductPrice %}
  {% assign reward_product_image = bundle_data.rewardProductImage %}

  {% comment %} Design config from metafield with fallback to block.settings {% endcomment %}
  {% assign ds_accent_color = bundle_data.designAccentColor | default: block.settings.accent_color %}
  {% assign ds_background_color = bundle_data.designBackgroundColor | default: block.settings.background_color %}
  {% assign ds_border_color = bundle_data.designBorderColor | default: block.settings.border_color %}
  {% assign ds_text_color = bundle_data.designTextColor | default: block.settings.text_color %}
  {% assign ds_button_color = bundle_data.designButtonColor | default: block.settings.button_color %}
  {% assign ds_button_text_color = bundle_data.designButtonTextColor | default: block.settings.button_text_color %}
  {% assign ds_border_radius = bundle_data.designBorderRadius | default: 12 %}
  {% assign ds_image_size = bundle_data.designImageSizePx | default: 120 %}
  {% assign ds_font_size = bundle_data.designFontSizePx | default: 14 %}
  {% assign ds_button_font_size = bundle_data.designButtonFontSizePx | default: 16 %}
  {% assign ds_badge_text = bundle_data.designBadgeText | default: block.settings.badge_text %}
  {% assign ds_card_layout = bundle_data.designCardLayout | default: "horizontal" %}

  {% comment %} Try to get live reward product data via all_products {% endcomment %}
  {% assign reward_product = all_products[reward_product_handle] %}

  {% comment %} Determine reward image {% endcomment %}
  {% if reward_product != blank and reward_product.featured_image != blank %}
    {% assign rw_image = reward_product.featured_image | image_url: width: 300 %}
  {% elsif reward_product_image != blank %}
    {% assign rw_image = reward_product_image %}
  {% else %}
    {% assign rw_image = '' %}
  {% endif %}

  {% comment %} Determine reward price (in cents) {% endcomment %}
  {% if reward_product != blank %}
    {% assign rw_price = reward_product.price %}
  {% elsif reward_product_price != blank %}
    {% assign rw_price = reward_product_price %}
  {% else %}
    {% assign rw_price = 0 %}
  {% endif %}

  {% comment %} Buy product data from current PDP {% endcomment %}
  {% assign buy_image = product.featured_image | image_url: width: 300 %}
  {% assign buy_price = product.price %}
  {% assign buy_title = product.title %}

  {% comment %} Calculate discounted reward price (in cents) {% endcomment %}
  {% if discount_type == "percentage" %}
    {% assign discount_fraction = discount_value | times: 100 | divided_by: 10000.0 %}
    {% assign rw_discounted = rw_price | times: 1.0 | times: discount_fraction %}
    {% assign rw_discounted = rw_price | minus: rw_discounted | round %}
  {% else %}
    {% assign discount_cents = discount_value | times: 100 %}
    {% assign rw_discounted = rw_price | minus: discount_cents %}
    {% if rw_discounted < 0 %}{% assign rw_discounted = 0 %}{% endif %}
  {% endif %}

  {% comment %} Check reward availability {% endcomment %}
  {% assign reward_available = true %}
  {% if reward_product != blank %}
    {% assign reward_available = reward_product.available %}
  {% endif %}

  {% comment %} Discount label {% endcomment %}
  {% if discount_type == "percentage" %}
    {% assign discount_label = discount_value | append: "% off" %}
  {% else %}
    {% assign discount_label = "$" | append: discount_value | append: " off" %}
  {% endif %}

<style>
  .bxgy-widget {
    border: 2px solid {{ ds_border_color }};
    border-radius: {{ ds_border_radius }}px;
    padding: 20px;
    margin: 16px 0;
    background: {{ ds_background_color }};
    font-family: inherit;
  }
  .bxgy-widget__badge {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
  }
  .bxgy-widget__badge-text {
    font-weight: 700;
    font-size: 13px;
    color: {{ ds_accent_color }};
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .bxgy-widget__products {
    display: flex;
    align-items: stretch;
    gap: 0;
    margin-bottom: 16px;
  }
  .bxgy-widget__products--vertical {
    flex-direction: column;
    align-items: stretch;
  }
  .bxgy-widget__products--vertical .bxgy-widget__plus {
    padding: 4px 0;
    transform: none;
  }
  .bxgy-widget__products--vertical .bxgy-widget__product-card {
    flex-direction: row;
    text-align: left;
    gap: 10px;
    width: 100%;
    max-width: none;
  }
  .bxgy-widget__products--vertical .bxgy-widget__product-image,
  .bxgy-widget__products--vertical .bxgy-widget__product-image-placeholder {
    width: 60px;
    max-width: 60px;
    margin-bottom: 0;
    flex-shrink: 0;
  }
  .bxgy-widget__products--vertical .bxgy-widget__product-details {
    flex: 1;
    min-width: 0;
  }
  .bxgy-widget__products--vertical .bxgy-widget__product-price-col {
    text-align: right;
    flex-shrink: 0;
  }
  .bxgy-widget__product-card {
    flex: 1;
    background: #fff;
    border: 1px solid #e5e5e5;
    border-radius: 10px;
    padding: 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    min-width: 0;
  }
  .bxgy-widget__product-image {
    width: 100%;
    max-width: {{ ds_image_size }}px;
    aspect-ratio: 1;
    object-fit: cover;
    border-radius: 8px;
    background: #f5f5f5;
    margin-bottom: 10px;
  }
  .bxgy-widget__product-image-placeholder {
    width: 100%;
    max-width: {{ ds_image_size }}px;
    aspect-ratio: 1;
    border-radius: 8px;
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    color: #999;
    font-size: 12px;
  }
  .bxgy-widget__product-title {
    font-size: {{ ds_font_size }}px;
    font-weight: 600;
    color: {{ ds_text_color }};
    margin-bottom: 4px;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .bxgy-widget__product-price {
    font-size: {{ ds_font_size }}px;
    font-weight: 600;
    color: {{ ds_text_color }};
    margin-bottom: 4px;
  }
  .bxgy-widget__product-price--original {
    text-decoration: line-through;
    color: #999;
    font-weight: 400;
    margin-right: 4px;
  }
  .bxgy-widget__product-price--discounted {
    color: #e53e3e;
    font-weight: 700;
  }
  .bxgy-widget__product-qty {
    font-size: 12px;
    color: #666;
    background: #f5f5f5;
    padding: 2px 10px;
    border-radius: 12px;
    margin-top: 4px;
  }
  .bxgy-widget__product-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    color: #666;
    margin-bottom: 8px;
  }
  .bxgy-widget__product-label--reward {
    color: {{ ds_accent_color }};
  }
  .bxgy-widget__plus {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 12px;
    font-size: 24px;
    font-weight: 700;
    color: {{ ds_accent_color }};
    flex-shrink: 0;
  }
  .bxgy-widget__variant-select {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 13px;
    font-family: inherit;
    background: #fff;
    color: {{ ds_text_color }};
    margin-top: 6px;
    cursor: pointer;
  }
  .bxgy-widget__summary {
    text-align: center;
    margin-bottom: 14px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 8px;
  }
  .bxgy-widget__summary-prices {
    font-size: 16px;
    margin-bottom: 2px;
  }
  .bxgy-widget__summary-original {
    text-decoration: line-through;
    color: #999;
    margin-right: 6px;
  }
  .bxgy-widget__summary-final {
    font-weight: 700;
    color: {{ ds_text_color }};
  }
  .bxgy-widget__summary-savings {
    font-size: 13px;
    font-weight: 600;
    color: #16a34a;
  }
  .bxgy-widget__add-btn {
    width: 100%;
    padding: 14px 20px;
    font-size: {{ ds_button_font_size }}px;
    font-weight: 700;
    font-family: inherit;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background: {{ ds_button_color }};
    color: {{ ds_button_text_color }};
    transition: opacity 0.2s;
    position: relative;
  }
  .bxgy-widget__add-btn:hover:not(:disabled) {
    opacity: 0.9;
  }
  .bxgy-widget__add-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .bxgy-widget__add-btn--loading {
    color: transparent !important;
  }
  .bxgy-widget__add-btn--loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 3px solid {{ ds_button_text_color }};
    border-top-color: transparent;
    border-radius: 50%;
    animation: bxgy-spin 0.7s linear infinite;
  }
  @keyframes bxgy-spin {
    to { transform: rotate(360deg); }
  }
  .bxgy-widget__feedback {
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    padding: 8px;
    border-radius: 6px;
    margin-top: 10px;
    display: none;
  }
  .bxgy-widget__feedback--success {
    display: block;
    color: #166534;
    background: #dcfce7;
  }
  .bxgy-widget__feedback--error {
    display: block;
    color: #991b1b;
    background: #fee2e2;
  }
  .bxgy-widget__footer {
    text-align: center;
    font-size: 12px;
    color: #888;
    margin-top: 10px;
  }
  @media (max-width: 749px) {
    .bxgy-widget__products--horizontal {
      flex-direction: column;
      align-items: center;
    }
    .bxgy-widget__products--horizontal .bxgy-widget__plus {
      padding: 6px 0;
      transform: rotate(90deg);
    }
    .bxgy-widget__products--horizontal .bxgy-widget__product-card {
      width: 100%;
      max-width: 280px;
    }
  }
</style>

<div class="bxgy-widget" id="bxgy-widget-{{ block.id }}">
  {% comment %} Badge {% endcomment %}
  <div class="bxgy-widget__badge">
    <svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M10 2L12.09 7.26L18 8.27L14 12.14L14.81 18.02L10 15.27L5.19 18.02L6 12.14L2 8.27L7.91 7.26L10 2Z" fill="{{ ds_accent_color }}"/>
    </svg>
    <span class="bxgy-widget__badge-text">{{ ds_badge_text }}</span>
  </div>

  {% comment %} Product cards {% endcomment %}
  <div class="bxgy-widget__products bxgy-widget__products--{{ ds_card_layout }}">
    {% comment %} === Buy Product Card === {% endcomment %}
    <div class="bxgy-widget__product-card">
      {% if buy_image != blank %}
        <img
          class="bxgy-widget__product-image"
          src="{{ buy_image }}"
          alt="{{ buy_title | escape }}"
          loading="lazy"
        >
      {% else %}
        <div class="bxgy-widget__product-image-placeholder">No image</div>
      {% endif %}
      <div class="bxgy-widget__product-details">
        <div class="bxgy-widget__product-label">Buy</div>
        <div class="bxgy-widget__product-title">{{ buy_title }}</div>
        <div class="bxgy-widget__product-qty">Qty: {{ min_quantity }}</div>
      </div>
      <div class="bxgy-widget__product-price-col">
        <div class="bxgy-widget__product-price" data-bxgy-buy-price>
          {{ buy_price | money }}
        </div>
      </div>
    </div>

    {% comment %} === Plus sign === {% endcomment %}
    <div class="bxgy-widget__plus">+</div>

    {% comment %} === Reward Product Card === {% endcomment %}
    <div class="bxgy-widget__product-card">
      {% if rw_image != blank %}
        <img
          class="bxgy-widget__product-image"
          src="{{ rw_image }}"
          alt="{{ reward_product_title | escape }}"
          loading="lazy"
          data-bxgy-reward-image
        >
      {% else %}
        <div class="bxgy-widget__product-image-placeholder">No image</div>
      {% endif %}
      <div class="bxgy-widget__product-details">
        <div class="bxgy-widget__product-label bxgy-widget__product-label--reward">
          Get {{ discount_label }}
        </div>
        <div class="bxgy-widget__product-title">{{ reward_product_title }}</div>
        {% comment %} Variant selector for reward product (if multi-variant) {% endcomment %}
        {% if reward_product != blank and reward_product.variants.size > 1 %}
          <select class="bxgy-widget__variant-select" data-bxgy-reward-variant-select>
            {% for variant in reward_product.variants %}
              {% if variant.available %}
                <option
                  value="{{ variant.id }}"
                  data-price="{{ variant.price }}"
                  {% if variant.featured_image %}data-image="{{ variant.featured_image | image_url: width: 300 }}"{% endif %}
                >
                  {{ variant.title }}{% if variant.title != "Default Title" %} - {{ variant.price | money }}{% endif %}
                </option>
              {% endif %}
            {% endfor %}
          </select>
        {% endif %}
      </div>
      <div class="bxgy-widget__product-price-col">
        <div class="bxgy-widget__product-price" data-bxgy-reward-price>
          {% if rw_discounted < rw_price %}
            <span class="bxgy-widget__product-price--original">{{ rw_price | money }}</span>
            <span class="bxgy-widget__product-price--discounted">{{ rw_discounted | money }}</span>
          {% else %}
            {{ rw_price | money }}
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% comment %} Summary section {% endcomment %}
  <div class="bxgy-widget__summary">
    <div class="bxgy-widget__summary-prices">
      <span class="bxgy-widget__summary-original" data-bxgy-total-original></span>
      <span class="bxgy-widget__summary-final" data-bxgy-total-final></span>
    </div>
    <div class="bxgy-widget__summary-savings" data-bxgy-savings></div>
  </div>

  {% comment %} Add to cart button {% endcomment %}
  <button
    class="bxgy-widget__add-btn"
    data-bxgy-add-btn
    {% unless reward_available %}disabled{% endunless %}
    type="button"
  >
    {% if reward_available %}
      Add Bundle to Cart
    {% else %}
      Reward Product Unavailable
    {% endif %}
  </button>

  {% comment %} Feedback message {% endcomment %}
  <div class="bxgy-widget__feedback" data-bxgy-feedback></div>

  {% comment %} Footer {% endcomment %}
  <div class="bxgy-widget__footer">Discount applied automatically at checkout</div>
</div>

<script>
(function() {
  var WIDGET_ID = 'bxgy-widget-{{ block.id }}';
  var widget = document.getElementById(WIDGET_ID);
  if (!widget) return;

  /* ── Config from Liquid ── */
  var config = {
    discountType: {{ discount_type | json }},
    discountValue: {{ discount_value | json }},
    minQuantity: {{ min_quantity | json }},
    maxReward: {{ max_reward | json }},
    rewardProductHandle: {{ reward_product_handle | json }},
    rewardAvailable: {{ reward_available | json }},
    /* Fallback reward variant ID from metafield */
    fallbackRewardVariantId: {{ reward_variant_id | json }},
    fallbackRewardPrice: {{ rw_price | json }},
    shopCurrency: {{ shop.currency | json }}
  };

  /* ── Buy product variants lookup (prices in cents) ── */
  var buyVariants = {};
  {% for variant in product.variants %}
    buyVariants['{{ variant.id }}'] = {
      price: {{ variant.price }},
      available: {{ variant.available | json }}
    };
  {% endfor %}
  window.__bxgy_buy_variants = buyVariants;

  /* ── DOM references ── */
  var buyPriceEl = widget.querySelector('[data-bxgy-buy-price]');
  var rewardPriceEl = widget.querySelector('[data-bxgy-reward-price]');
  var rewardImageEl = widget.querySelector('[data-bxgy-reward-image]');
  var rewardSelect = widget.querySelector('[data-bxgy-reward-variant-select]');
  var totalOriginalEl = widget.querySelector('[data-bxgy-total-original]');
  var totalFinalEl = widget.querySelector('[data-bxgy-total-final]');
  var savingsEl = widget.querySelector('[data-bxgy-savings]');
  var addBtn = widget.querySelector('[data-bxgy-add-btn]');
  var feedbackEl = widget.querySelector('[data-bxgy-feedback]');

  /* ── Helpers ── */
  function formatMoney(cents) {
    return new Intl.NumberFormat(undefined, {
      style: 'currency',
      currency: config.shopCurrency || 'USD'
    }).format(cents / 100);
  }

  function getDiscountedPrice(priceCents) {
    if (config.discountType === 'percentage') {
      return Math.round(priceCents * (1 - config.discountValue / 100));
    } else {
      var off = config.discountValue * 100;
      return Math.max(0, priceCents - off);
    }
  }

  /* ── State ── */
  var currentBuyPrice = {{ buy_price | json }};
  var currentBuyVariantId = null;
  var currentRewardPrice = {{ rw_price | json }};
  var currentRewardVariantId = null;

  /* Detect initial buy variant from URL or form */
  function detectBuyVariant() {
    /* 1. URL param */
    var urlParams = new URLSearchParams(window.location.search);
    var urlVariant = urlParams.get('variant');
    if (urlVariant && buyVariants[urlVariant]) {
      return urlVariant;
    }
    /* 2. Hidden form input */
    var input = document.querySelector('form[action*="/cart/add"] input[name="id"]');
    if (input) {
      var val = input.value;
      if (val && buyVariants[val]) return val;
    }
    /* 3. Select element */
    var select = document.querySelector('form[action*="/cart/add"] select[name="id"]');
    if (select) {
      var val2 = select.value;
      if (val2 && buyVariants[val2]) return val2;
    }
    /* 4. First available variant */
    var keys = Object.keys(buyVariants);
    for (var i = 0; i < keys.length; i++) {
      if (buyVariants[keys[i]].available) return keys[i];
    }
    return keys[0] || null;
  }

  /* Detect initial reward variant */
  function detectRewardVariant() {
    if (rewardSelect) {
      return rewardSelect.value;
    }
    return config.fallbackRewardVariantId || null;
  }

  /* ── Update display ── */
  function updatePrices() {
    /* Buy price */
    if (currentBuyVariantId && buyVariants[currentBuyVariantId]) {
      currentBuyPrice = buyVariants[currentBuyVariantId].price;
    }
    if (buyPriceEl) {
      buyPriceEl.textContent = formatMoney(currentBuyPrice);
    }

    /* Reward price */
    var rewardDiscounted = getDiscountedPrice(currentRewardPrice);
    if (rewardPriceEl) {
      if (rewardDiscounted < currentRewardPrice) {
        rewardPriceEl.innerHTML =
          '<span class="bxgy-widget__product-price--original">' + formatMoney(currentRewardPrice) + '</span> ' +
          '<span class="bxgy-widget__product-price--discounted">' + formatMoney(rewardDiscounted) + '</span>';
      } else {
        rewardPriceEl.textContent = formatMoney(currentRewardPrice);
      }
    }

    /* Bundle totals */
    var totalOriginal = (currentBuyPrice * config.minQuantity) + currentRewardPrice;
    var totalFinal = (currentBuyPrice * config.minQuantity) + rewardDiscounted;
    var savings = totalOriginal - totalFinal;

    if (totalOriginalEl) {
      totalOriginalEl.textContent = savings > 0 ? formatMoney(totalOriginal) : '';
    }
    if (totalFinalEl) {
      totalFinalEl.textContent = formatMoney(totalFinal);
    }
    if (savingsEl) {
      savingsEl.textContent = savings > 0 ? 'You save ' + formatMoney(savings) : '';
    }
  }

  /* ── Buy variant change listeners ── */
  function onBuyVariantChange(variantId) {
    if (variantId && buyVariants[variantId]) {
      currentBuyVariantId = variantId;
      updatePrices();
    }
  }

  /* Listen for URL changes (variant= param) */
  function checkUrlVariant() {
    var urlParams = new URLSearchParams(window.location.search);
    var v = urlParams.get('variant');
    if (v && v !== currentBuyVariantId) {
      onBuyVariantChange(v);
    }
  }
  window.addEventListener('popstate', checkUrlVariant);

  /* Listen for custom variant change events (common in themes) */
  document.addEventListener('variant:changed', function(e) {
    if (e.detail && e.detail.variant && e.detail.variant.id) {
      onBuyVariantChange(String(e.detail.variant.id));
    }
  });

  /* MutationObserver on the variant input */
  var variantInput = document.querySelector('form[action*="/cart/add"] input[name="id"]');
  if (variantInput) {
    var observer = new MutationObserver(function() {
      onBuyVariantChange(variantInput.value);
    });
    observer.observe(variantInput, { attributes: true, attributeFilter: ['value'] });
    /* Also listen for change event on selects */
    var variantSelect = document.querySelector('form[action*="/cart/add"] select[name="id"]');
    if (variantSelect) {
      variantSelect.addEventListener('change', function() {
        onBuyVariantChange(variantSelect.value);
      });
    }
  }

  /* Poll URL for variant changes (catches pushState which doesn't fire popstate) */
  var lastUrl = window.location.href;
  setInterval(function() {
    if (window.location.href !== lastUrl) {
      lastUrl = window.location.href;
      checkUrlVariant();
    }
  }, 500);

  /* ── Reward variant change listener ── */
  if (rewardSelect) {
    rewardSelect.addEventListener('change', function() {
      currentRewardVariantId = rewardSelect.value;
      var selected = rewardSelect.options[rewardSelect.selectedIndex];
      if (selected) {
        var price = selected.getAttribute('data-price');
        if (price) currentRewardPrice = parseInt(price, 10);
        var img = selected.getAttribute('data-image');
        if (img && rewardImageEl) rewardImageEl.src = img;
      }
      updatePrices();
    });
  }

  /* ── Add Bundle to Cart ── */
  function showFeedback(type, message) {
    feedbackEl.textContent = message;
    feedbackEl.className = 'bxgy-widget__feedback bxgy-widget__feedback--' + type;
    if (type === 'success') {
      setTimeout(function() {
        feedbackEl.className = 'bxgy-widget__feedback';
      }, 4000);
    }
  }

  function updateCartCount(items) {
    /* Try common selectors for cart count badges */
    var selectors = [
      '.cart-count-bubble span[aria-hidden="true"]',
      '.cart-count-bubble',
      '.cart-count',
      '[data-cart-count]',
      '.site-header__cart-count',
      '#cart-icon-bubble span',
      '.header__cart-count'
    ];
    var totalAdded = 0;
    items.forEach(function(item) { totalAdded += item.quantity; });

    for (var i = 0; i < selectors.length; i++) {
      var el = document.querySelector(selectors[i]);
      if (el) {
        var current = parseInt(el.textContent, 10) || 0;
        el.textContent = current + totalAdded;
        break;
      }
    }
  }

  addBtn.addEventListener('click', function() {
    if (addBtn.disabled) return;

    /* Determine variant IDs */
    var buyVid = currentBuyVariantId || detectBuyVariant();
    var rewardVid = currentRewardVariantId || detectRewardVariant();

    if (!buyVid) {
      showFeedback('error', 'Please select a variant for the product.');
      return;
    }
    if (!rewardVid) {
      showFeedback('error', 'Reward product variant not available.');
      return;
    }

    /* Loading state */
    addBtn.disabled = true;
    addBtn.classList.add('bxgy-widget__add-btn--loading');
    feedbackEl.className = 'bxgy-widget__feedback';

    var items = [
      { id: Number(buyVid), quantity: config.minQuantity },
      { id: Number(rewardVid), quantity: 1, properties: { '_bxgy_reward': 'true' } }
    ];

    fetch('/cart/add.js', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ items: items })
    })
    .then(function(response) {
      if (!response.ok) {
        return response.json().then(function(data) {
          throw new Error(data.description || data.message || 'Failed to add to cart');
        });
      }
      return response.json();
    })
    .then(function(data) {
      addBtn.disabled = false;
      addBtn.classList.remove('bxgy-widget__add-btn--loading');
      showFeedback('success', 'Bundle added to cart!');
      updateCartCount(items);
    })
    .catch(function(err) {
      addBtn.disabled = false;
      addBtn.classList.remove('bxgy-widget__add-btn--loading');
      showFeedback('error', err.message || 'Something went wrong. Please try again.');
    });
  });

  /* ── Initialize ── */
  currentBuyVariantId = detectBuyVariant();
  currentRewardVariantId = detectRewardVariant();
  updatePrices();

})();
</script>

{% else %}
  {% comment %} Preview/fallback when no bundle is configured {% endcomment %}
  {% assign discount_label = block.settings.preview_discount %}
  {% assign min_quantity = block.settings.preview_min_qty %}
  {% assign reward_product_title = block.settings.preview_reward %}

  <div style="
    border: 2px solid {{ block.settings.border_color }};
    border-radius: 12px;
    padding: 20px;
    margin: 16px 0;
    background: {{ block.settings.background_color }};
    font-family: inherit;
  ">
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
      <svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 2L12.09 7.26L18 8.27L14 12.14L14.81 18.02L10 15.27L5.19 18.02L6 12.14L2 8.27L7.91 7.26L10 2Z" fill="{{ block.settings.accent_color }}"/>
      </svg>
      <span style="font-weight: 700; font-size: 13px; color: {{ block.settings.accent_color }}; text-transform: uppercase; letter-spacing: 0.5px;">
        {{ block.settings.badge_text }}
      </span>
    </div>
    <p style="font-size: 16px; font-weight: 600; margin: 0 0 4px 0; color: {{ block.settings.text_color }};">
      Buy {{ min_quantity }}+, get {{ reward_product_title }} {{ discount_label }}
    </p>
    <p style="font-size: 12px; margin: 8px 0 0 0; color: {{ block.settings.text_color }}; opacity: 0.7;">
      Discount applied automatically at checkout
    </p>
  </div>
{% endif %}

{% schema %}
{
  "name": "BXGY Bundle Promo",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "badge_text",
      "label": "Badge text",
      "default": "Bundle Deal"
    },
    {
      "type": "text",
      "id": "preview_discount",
      "label": "Fallback discount text",
      "default": "50% off",
      "info": "Shown when no bundle is configured via the app for this product"
    },
    {
      "type": "text",
      "id": "preview_min_qty",
      "label": "Fallback min quantity",
      "default": "2"
    },
    {
      "type": "text",
      "id": "preview_reward",
      "label": "Fallback reward product name",
      "default": "a free gift",
      "info": "Shown when no bundle is configured via the app for this product"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent color",
      "default": "#e85d04"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#fff8f0"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border color",
      "default": "#e85d04"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button color",
      "default": "#e85d04"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text color",
      "default": "#ffffff"
    }
  ]
}
{% endschema %}

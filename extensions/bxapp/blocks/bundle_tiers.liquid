{% assign bundle_data = product.metafields.bxgy_bundle.tiered_config.value %}

{% if bundle_data != blank %}
  {% comment %} Design from metafield with fallback {% endcomment %}
  {% assign ds_accent = bundle_data.designAccentColor | default: block.settings.accent_color %}
  {% assign ds_bg = bundle_data.designBackgroundColor | default: block.settings.background_color %}
  {% assign ds_text = bundle_data.designTextColor | default: block.settings.text_color %}
  {% assign ds_border_radius = bundle_data.designBorderRadius | default: 12 %}
  {% assign ds_button_color = bundle_data.designButtonColor | default: block.settings.accent_color %}
  {% assign ds_button_text = bundle_data.designButtonTextColor | default: "#ffffff" %}

  {% assign header_text = bundle_data.designHeaderText | default: block.settings.header_text %}
  {% assign gift_text = bundle_data.designGiftText | default: block.settings.gift_text %}

  {% comment %} Tiers from metafield {% endcomment %}
  {% assign t1_buy = bundle_data.tier1BuyQty | default: 1 %}
  {% assign t1_free = bundle_data.tier1FreeQty | default: 1 %}
  {% assign t1_disc = bundle_data.tier1DiscountPct | default: 100 %}
  {% assign t2_buy = bundle_data.tier2BuyQty | default: 2 %}
  {% assign t2_free = bundle_data.tier2FreeQty | default: 3 %}
  {% assign t2_disc = bundle_data.tier2DiscountPct | default: 100 %}
  {% assign t3_buy = bundle_data.tier3BuyQty | default: 3 %}
  {% assign t3_free = bundle_data.tier3FreeQty | default: 6 %}
  {% assign t3_disc = bundle_data.tier3DiscountPct | default: 100 %}

  {% assign buy_price = product.price %}
  {% assign buy_title = product.title %}

  {% comment %} Calculate tier prices (all in cents) {% endcomment %}
  {% assign t1_total_qty = t1_buy | plus: t1_free %}
  {% assign t1_original = t1_total_qty | times: buy_price %}
  {% assign t1_free_cost = t1_free | times: buy_price %}
  {% assign t1_save_amount = t1_free_cost | times: t1_disc | divided_by: 100 %}
  {% assign t1_final = t1_original | minus: t1_save_amount %}
  {% assign t1_save_pct = t1_save_amount | times: 100 | divided_by: t1_original %}

  {% assign t2_total_qty = t2_buy | plus: t2_free %}
  {% assign t2_original = t2_total_qty | times: buy_price %}
  {% assign t2_free_cost = t2_free | times: buy_price %}
  {% assign t2_save_amount = t2_free_cost | times: t2_disc | divided_by: 100 %}
  {% assign t2_final = t2_original | minus: t2_save_amount %}
  {% assign t2_save_pct = t2_save_amount | times: 100 | divided_by: t2_original %}

  {% assign t3_total_qty = t3_buy | plus: t3_free %}
  {% assign t3_original = t3_total_qty | times: buy_price %}
  {% assign t3_free_cost = t3_free | times: buy_price %}
  {% assign t3_save_amount = t3_free_cost | times: t3_disc | divided_by: 100 %}
  {% assign t3_final = t3_original | minus: t3_save_amount %}
  {% assign t3_save_pct = t3_save_amount | times: 100 | divided_by: t3_original %}

<style>
  .bxgy-tiers {
    background: {{ ds_bg }};
    border-radius: {{ ds_border_radius }}px;
    padding: 20px;
    margin: 16px 0;
    font-family: inherit;
    border: 1px solid #e5e5e5;
  }
  .bxgy-tiers__header {
    border-bottom: 2px solid {{ ds_text }};
    padding-bottom: 10px;
    margin-bottom: 14px;
    text-align: center;
  }
  .bxgy-tiers__header-text {
    font-weight: 800;
    font-size: 15px;
    color: {{ ds_text }};
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .bxgy-tiers__list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 14px;
  }
  .bxgy-tiers__row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    border-radius: 28px;
    border: 2px solid #e5e5e5;
    background: #fff;
    cursor: pointer;
    transition: all 0.15s ease;
    user-select: none;
  }
  .bxgy-tiers__row:hover {
    border-color: {{ ds_accent }};
  }
  .bxgy-tiers__row--selected {
    border-color: {{ ds_accent }};
    background: {{ ds_bg }};
  }
  .bxgy-tiers__radio {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid #ccc;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: border-color 0.15s;
  }
  .bxgy-tiers__row--selected .bxgy-tiers__radio {
    border-color: {{ ds_accent }};
  }
  .bxgy-tiers__radio-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: transparent;
    transition: background 0.15s;
  }
  .bxgy-tiers__row--selected .bxgy-tiers__radio-dot {
    background: {{ ds_accent }};
  }
  .bxgy-tiers__label {
    flex: 1;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }
  .bxgy-tiers__label-text {
    font-weight: 600;
    font-size: 14px;
    color: {{ ds_text }};
  }
  .bxgy-tiers__badge {
    font-size: 11px;
    font-weight: 700;
    color: {{ ds_accent }};
    background: {{ ds_accent }}18;
    padding: 2px 10px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .bxgy-tiers__prices {
    text-align: right;
    flex-shrink: 0;
  }
  .bxgy-tiers__price-final {
    font-weight: 700;
    font-size: 16px;
    color: {{ ds_text }};
    line-height: 1.2;
  }
  .bxgy-tiers__row--selected .bxgy-tiers__price-final {
    color: {{ ds_accent }};
  }
  .bxgy-tiers__price-original {
    font-size: 12px;
    color: #999;
    text-decoration: line-through;
    line-height: 1.2;
  }
  .bxgy-tiers__gift {
    background: {{ ds_accent }}12;
    border-radius: 8px;
    padding: 12px 16px;
    text-align: center;
    margin-bottom: 14px;
  }
  .bxgy-tiers__gift-text {
    font-weight: 700;
    font-size: 14px;
    color: {{ ds_text }};
  }
  .bxgy-tiers__add-btn {
    width: 100%;
    padding: 14px 20px;
    font-size: 16px;
    font-weight: 700;
    font-family: inherit;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    background: {{ ds_button_color }};
    color: {{ ds_button_text }};
    transition: opacity 0.2s;
    position: relative;
  }
  .bxgy-tiers__add-btn:hover:not(:disabled) {
    opacity: 0.9;
  }
  .bxgy-tiers__add-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .bxgy-tiers__add-btn--loading {
    color: transparent !important;
  }
  .bxgy-tiers__add-btn--loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 3px solid {{ ds_button_text }};
    border-top-color: transparent;
    border-radius: 50%;
    animation: bxgy-tiers-spin 0.7s linear infinite;
  }
  @keyframes bxgy-tiers-spin {
    to { transform: rotate(360deg); }
  }
  .bxgy-tiers__feedback {
    text-align: center;
    font-size: 14px;
    font-weight: 600;
    padding: 8px;
    border-radius: 6px;
    margin-top: 10px;
    display: none;
  }
  .bxgy-tiers__feedback--success {
    display: block;
    color: #166534;
    background: #dcfce7;
  }
  .bxgy-tiers__feedback--error {
    display: block;
    color: #991b1b;
    background: #fee2e2;
  }
  .bxgy-tiers__footer {
    text-align: center;
    font-size: 12px;
    color: #888;
    margin-top: 10px;
  }
</style>

<div class="bxgy-tiers" id="bxgy-tiers-{{ block.id }}">
  {% comment %} Header {% endcomment %}
  <div class="bxgy-tiers__header">
    <span class="bxgy-tiers__header-text">{{ header_text }}</span>
  </div>

  {% if t1_disc >= 100 %}{% assign t1_deal = "free" %}{% else %}{% assign t1_deal = t1_disc | append: "% off" %}{% endif %}
  {% if t2_disc >= 100 %}{% assign t2_deal = "free" %}{% else %}{% assign t2_deal = t2_disc | append: "% off" %}{% endif %}
  {% if t3_disc >= 100 %}{% assign t3_deal = "free" %}{% else %}{% assign t3_deal = t3_disc | append: "% off" %}{% endif %}

  {% comment %} Tier rows {% endcomment %}
  <div class="bxgy-tiers__list">
    <div class="bxgy-tiers__row" data-bxgy-tier="0" data-buy-qty="{{ t1_buy }}" data-free-qty="{{ t1_free }}" data-disc-pct="{{ t1_disc }}">
      <div class="bxgy-tiers__radio"><div class="bxgy-tiers__radio-dot"></div></div>
      <div class="bxgy-tiers__label">
        <span class="bxgy-tiers__label-text">Buy {{ t1_buy }}, get {{ t1_free }} {{ t1_deal }}</span>
        <span class="bxgy-tiers__badge">SAVE {{ t1_save_pct }}%</span>
      </div>
      <div class="bxgy-tiers__prices">
        <div class="bxgy-tiers__price-final" data-bxgy-tier-final="0">{{ t1_final | money }}</div>
        <div class="bxgy-tiers__price-original" data-bxgy-tier-original="0">{{ t1_original | money }}</div>
      </div>
    </div>

    <div class="bxgy-tiers__row bxgy-tiers__row--selected" data-bxgy-tier="1" data-buy-qty="{{ t2_buy }}" data-free-qty="{{ t2_free }}" data-disc-pct="{{ t2_disc }}">
      <div class="bxgy-tiers__radio"><div class="bxgy-tiers__radio-dot"></div></div>
      <div class="bxgy-tiers__label">
        <span class="bxgy-tiers__label-text">Buy {{ t2_buy }}, get {{ t2_free }} {{ t2_deal }}</span>
        <span class="bxgy-tiers__badge">SAVE {{ t2_save_pct }}%</span>
      </div>
      <div class="bxgy-tiers__prices">
        <div class="bxgy-tiers__price-final" data-bxgy-tier-final="1">{{ t2_final | money }}</div>
        <div class="bxgy-tiers__price-original" data-bxgy-tier-original="1">{{ t2_original | money }}</div>
      </div>
    </div>

    <div class="bxgy-tiers__row" data-bxgy-tier="2" data-buy-qty="{{ t3_buy }}" data-free-qty="{{ t3_free }}" data-disc-pct="{{ t3_disc }}">
      <div class="bxgy-tiers__radio"><div class="bxgy-tiers__radio-dot"></div></div>
      <div class="bxgy-tiers__label">
        <span class="bxgy-tiers__label-text">Buy {{ t3_buy }}, get {{ t3_free }} {{ t3_deal }}</span>
        <span class="bxgy-tiers__badge">SAVE {{ t3_save_pct }}%</span>
      </div>
      <div class="bxgy-tiers__prices">
        <div class="bxgy-tiers__price-final" data-bxgy-tier-final="2">{{ t3_final | money }}</div>
        <div class="bxgy-tiers__price-original" data-bxgy-tier-original="2">{{ t3_original | money }}</div>
      </div>
    </div>
  </div>

  {% comment %} Gift footer {% endcomment %}
  {% if gift_text != blank %}
    <div class="bxgy-tiers__gift">
      <span class="bxgy-tiers__gift-text">{{ gift_text }}</span>
    </div>
  {% endif %}

  {% comment %} Add to cart button {% endcomment %}
  <button
    class="bxgy-tiers__add-btn"
    data-bxgy-tiers-add-btn
    {% unless product.available %}disabled{% endunless %}
    type="button"
  >
    Add Bundle to Cart
  </button>

  {% comment %} Feedback {% endcomment %}
  <div class="bxgy-tiers__feedback" data-bxgy-tiers-feedback></div>

  {% comment %} Footer {% endcomment %}
  <div class="bxgy-tiers__footer">Discount applied automatically at checkout</div>
</div>

<script>
(function() {
  var WIDGET_ID = 'bxgy-tiers-{{ block.id }}';
  var widget = document.getElementById(WIDGET_ID);
  if (!widget) return;

  var shopCurrency = {{ shop.currency | json }};

  /* Product variants – keyed by numeric ID (string) */
  var buyVariants = {};
  {% for variant in product.variants %}
    buyVariants['{{ variant.id }}'] = {
      price: {{ variant.price }},
      available: {{ variant.available | json }}
    };
  {% endfor %}

  var rows = widget.querySelectorAll('[data-bxgy-tier]');
  var addBtn = widget.querySelector('[data-bxgy-tiers-add-btn]');
  var feedbackEl = widget.querySelector('[data-bxgy-tiers-feedback]');
  var selectedTier = 1; /* default to middle tier */

  /* ── Helpers ── */
  function formatMoney(cents) {
    return new Intl.NumberFormat(undefined, {
      style: 'currency',
      currency: shopCurrency || 'USD'
    }).format(cents / 100);
  }

  function getSelectedVariantId() {
    /* 1. URL ?variant= param */
    var urlParams = new URLSearchParams(window.location.search);
    var v = urlParams.get('variant');
    if (v && buyVariants[v]) return v;

    /* 2. Hidden input inside product form */
    var input = document.querySelector('form[action*="/cart/add"] input[name="id"]');
    if (input && input.value && buyVariants[input.value]) return input.value;

    /* 3. Select dropdown inside product form */
    var sel = document.querySelector('form[action*="/cart/add"] select[name="id"]');
    if (sel && sel.value && buyVariants[sel.value]) return sel.value;

    /* 4. Radios (some themes) */
    var radio = document.querySelector('form[action*="/cart/add"] input[name="id"]:checked');
    if (radio && radio.value && buyVariants[radio.value]) return radio.value;

    /* 5. First available variant as fallback */
    var keys = Object.keys(buyVariants);
    for (var i = 0; i < keys.length; i++) {
      if (buyVariants[keys[i]].available) return keys[i];
    }
    return keys[0] || null;
  }

  function getVariantPrice() {
    var vid = getSelectedVariantId();
    return vid && buyVariants[vid] ? buyVariants[vid].price : 0;
  }

  /* ── Tier price update ── */
  function updateTierPrices() {
    var price = getVariantPrice();
    rows.forEach(function(row) {
      var buyQty  = parseInt(row.getAttribute('data-buy-qty'), 10);
      var freeQty = parseInt(row.getAttribute('data-free-qty'), 10);
      var discPct = parseInt(row.getAttribute('data-disc-pct'), 10) || 100;
      var totalQty = buyQty + freeQty;
      var original = totalQty * price;
      var savings  = Math.round(freeQty * price * discPct / 100);
      var finalVal = original - savings;
      var idx = row.getAttribute('data-bxgy-tier');
      var finalEl = widget.querySelector('[data-bxgy-tier-final="' + idx + '"]');
      var origEl  = widget.querySelector('[data-bxgy-tier-original="' + idx + '"]');
      if (finalEl) finalEl.textContent = formatMoney(finalVal);
      if (origEl)  origEl.textContent  = formatMoney(original);
    });
  }

  /* ── Tier selection ── */
  function selectTier(index) {
    selectedTier = index;
    rows.forEach(function(row) {
      var idx = parseInt(row.getAttribute('data-bxgy-tier'), 10);
      row.classList.toggle('bxgy-tiers__row--selected', idx === index);
    });
  }

  rows.forEach(function(row) {
    row.addEventListener('click', function() {
      selectTier(parseInt(row.getAttribute('data-bxgy-tier'), 10));
    });
  });

  /* ── Variant change listeners ── */
  var lastUrl = window.location.href;
  setInterval(function() {
    if (window.location.href !== lastUrl) {
      lastUrl = window.location.href;
      updateTierPrices();
    }
  }, 500);

  var formSelector = 'form[action*="/cart/add"]';
  var variantInput = document.querySelector(formSelector + ' input[name="id"]');
  if (variantInput) {
    new MutationObserver(function() { updateTierPrices(); })
      .observe(variantInput, { attributes: true, attributeFilter: ['value'] });
  }
  var variantSelect = document.querySelector(formSelector + ' select[name="id"]');
  if (variantSelect) {
    variantSelect.addEventListener('change', function() { updateTierPrices(); });
  }

  document.addEventListener('variant:changed', function(e) {
    if (e.detail && e.detail.variant) updateTierPrices();
  });

  /* ── Feedback ── */
  function showFeedback(type, message) {
    feedbackEl.textContent = message;
    feedbackEl.className = 'bxgy-tiers__feedback bxgy-tiers__feedback--' + type;
    if (type === 'success') {
      setTimeout(function() { feedbackEl.className = 'bxgy-tiers__feedback'; }, 4000);
    }
  }

  /* ── Refresh theme cart (drawer / header count) ── */
  function refreshCart() {
    /* Dispatch a cart update event that most themes listen for */
    document.documentElement.dispatchEvent(
      new CustomEvent('cart:refresh', { bubbles: true })
    );
    /* Also try Shopify Section Rendering API to refresh cart sections */
    fetch('/cart.js', { credentials: 'same-origin' })
      .then(function(r) { return r.json(); })
      .then(function(cart) {
        /* Update header cart count badges (common selectors) */
        var badges = document.querySelectorAll(
          '.cart-count-bubble span, .cart-count, [data-cart-count], .js-cart-count, #cart-icon-bubble span'
        );
        badges.forEach(function(el) { el.textContent = cart.item_count; });
      })
      .catch(function() { /* ignore */ });
  }

  /* ── Add to cart ── */
  addBtn.addEventListener('click', function() {
    if (addBtn.disabled) return;

    var selectedRow = widget.querySelector('[data-bxgy-tier="' + selectedTier + '"]');
    if (!selectedRow) return;

    var buyQty  = parseInt(selectedRow.getAttribute('data-buy-qty'), 10);
    var freeQty = parseInt(selectedRow.getAttribute('data-free-qty'), 10);
    var variantId = getSelectedVariantId();

    if (!variantId) {
      showFeedback('error', 'Please select a product variant.');
      return;
    }

    addBtn.disabled = true;
    addBtn.classList.add('bxgy-tiers__add-btn--loading');
    feedbackEl.className = 'bxgy-tiers__feedback';

    var totalQty = buyQty + freeQty;

    fetch('/cart/add.js', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({
        items: [{ id: parseInt(variantId, 10), quantity: totalQty }]
      })
    })
    .then(function(response) {
      if (!response.ok) {
        return response.json().then(function(data) {
          throw new Error(data.description || data.message || 'Failed to add to cart');
        });
      }
      return response.json();
    })
    .then(function() {
      addBtn.disabled = false;
      addBtn.classList.remove('bxgy-tiers__add-btn--loading');
      showFeedback('success', 'Bundle added to cart!');
      refreshCart();
    })
    .catch(function(err) {
      addBtn.disabled = false;
      addBtn.classList.remove('bxgy-tiers__add-btn--loading');
      showFeedback('error', err.message || 'Something went wrong. Please try again.');
    });
  });

  /* Init */
  updateTierPrices();
})();
</script>

{% elsif bundle_data == blank %}
  {% comment %} Fallback preview when no bundle configured {% endcomment %}
  <div style="
    background: {{ block.settings.background_color }};
    border-radius: 12px;
    padding: 20px;
    margin: 16px 0;
    border: 1px solid #e5e5e5;
    font-family: inherit;
  ">
    <div style="border-bottom: 2px solid {{ block.settings.text_color }}; padding-bottom: 10px; margin-bottom: 14px; text-align: center;">
      <span style="font-weight: 800; font-size: 15px; color: {{ block.settings.text_color }}; text-transform: uppercase; letter-spacing: 0.5px;">
        {{ block.settings.header_text }}
      </span>
    </div>
    <div style="padding: 14px 16px; border-radius: 28px; border: 2px solid {{ block.settings.accent_color }}; background: {{ block.settings.background_color }}; display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
      <div style="width: 22px; height: 22px; border-radius: 50%; border: 2px solid {{ block.settings.accent_color }}; display: flex; align-items: center; justify-content: center;">
        <div style="width: 12px; height: 12px; border-radius: 50%; background: {{ block.settings.accent_color }};"></div>
      </div>
      <span style="font-weight: 600; font-size: 14px; color: {{ block.settings.text_color }}; flex: 1;">Buy 2, get 3 free</span>
      <span style="font-weight: 700; font-size: 16px; color: {{ block.settings.accent_color }};">SAVE 60%</span>
    </div>
    <p style="font-size: 12px; margin: 12px 0 0 0; color: {{ block.settings.text_color }}; opacity: 0.7; text-align: center;">
      Configure this bundle via the app to see live tiers
    </p>
  </div>
{% endif %}

{% schema %}
{
  "name": "BXGY Tiered Combo",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "header_text",
      "label": "Header text",
      "default": "BUILD YOUR COMBO & SAVE"
    },
    {
      "type": "text",
      "id": "gift_text",
      "label": "Gift text",
      "default": "+ FREE special gift!"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent color",
      "default": "#8cb600"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#fafff0"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#1a1a1a"
    }
  ]
}
{% endschema %}
